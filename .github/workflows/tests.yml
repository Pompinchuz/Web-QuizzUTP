name: Ejecución Automática de Pruebas

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  frontend-tests:
    name: Pruebas Frontend (React + Vitest)
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar linter
        run: npm run lint

      - name: Ejecutar pruebas unitarias
        run: npm run test:run

      - name: Generar reporte de cobertura
        run: npm run test:coverage
        continue-on-error: true

      - name: Construir proyecto
        run: npm run build

  backend-tests:
    name: Pruebas Backend (Spring Boot + JUnit)
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Ejecutar pruebas con Maven
        run: ./mvnw test

      - name: Construir proyecto con Maven
        run: ./mvnw clean package -DskipTests

  status-check:
    name: Estado General de Pruebas
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    if: always()

    steps:
      - name: Verificar estado de pruebas
        run: |
          if [ "${{ needs.frontend-tests.result }}" == "success" ] && [ "${{ needs.backend-tests.result }}" == "success" ]; then
            echo "✅ Todas las pruebas pasaron exitosamente"
            exit 0
          else
            echo "❌ Algunas pruebas fallaron"
            echo "Frontend: ${{ needs.frontend-tests.result }}"
            echo "Backend: ${{ needs.backend-tests.result }}"
            exit 1
          fi
